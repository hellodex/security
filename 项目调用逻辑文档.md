# HelloSecurity 项目调用逻辑文档

## 项目概述

HelloSecurity 是一个基于 Go 语言开发的加密货币钱包安全服务系统，主要提供钱包生成、私钥管理、交易签名、多链支持等功能。项目采用模块化设计，支持 Solana 和 EVM 链系列（如 BSC、Ethereum 等）。

## 项目架构

```
HelloSecurity/
├── 入口层          - main.go (应用启动入口)
├── API层           - api/ (HTTP API 和路由管理)
├── 业务逻辑层      - api/http/controller/ (业务控制器)
├── 中间件层        - api/interceptor/ (请求拦截器)
├── 区块链交互层    - chain/ (区块链交易处理)
├── 钱包管理层      - wallet/ (钱包生成和加密)
├── 数据存储层      - model/ store/ system/ (数据模型和存储)
├── 配置管理层      - config/ (配置文件管理)
├── 工具层          - codes/ log/ runtime/ (工具和辅助功能)
└── 外部服务层      - swapData/ tasks/ rpc/ (外部API集成)
```

## 核心模块调用关系

### 1. 应用启动流程

```
main.go
├── config.GetConfig()           # 加载配置文件
├── runtime.InitSys()           # 初始化系统模式
├── net.Listen()                # 启动TCP服务器
├── handleMgrConnection()       # 处理命令行连接
└── router.Init()               # 启动HTTP API服务
```

**详细流程：**
1. **配置初始化**：加载 `config/dev.yml` 配置文件
2. **系统模式设置**：根据启动参数设置为 `token` 或 `slot` 模式
3. **TCP服务器**：启动命令行管理接口 (默认端口: cmd.port)
4. **HTTP API服务**：启动RESTful API服务 (默认端口: http.port)

### 2. HTTP API 调用链

```
HTTP请求
↓
router.Init() (api/router.go)
├── interceptor.HttpInterceptor()     # 请求拦截和认证
├── general.Routers()                 # 路由注册
└── controller.方法()                 # 业务处理
    ├── store.数据操作()              # 数据存储
    ├── chain.交易处理()              # 区块链交互
    └── wallet.钱包操作()             # 钱包管理
```

**主要API端点：**
- `/spwapi/auth/wallet/sig` - 钱包签名
- `/spwapi/auth/wallet/transfer` - 资金转账
- `/spwapi/auth/user/login` - 用户登录
- `/spwapi/auth/meme/` - MEME代币相关操作

### 3. 钱包管理调用链

```
钱包请求
↓
controller.AuthSig() (api/http/controller/system.go)
├── store.WalletKeyCheckAndGet()      # 验证钱包密钥
├── model.WalletGenerated查询         # 获取钱包信息
├── chain.HandleMessage()             # 处理交易消息
│   ├── enc.Porter().SigSol()         # Solana签名
│   ├── enc.Porter().SigEth()         # EVM链签名
│   └── SendAndConfirmTransaction()   # 发送并确认交易
└── model.WalletLog保存               # 记录操作日志
```

**钱包生成流程：**
```
GetWalletByUserNo()
├── model.WalletGroup查询             # 获取用户钱包组
├── wallet.Generate()                # 生成新钱包
│   ├── enc.NewKeyStories()          # 生成助记词
│   ├── wallet.ChainCode()           # 生成链特定地址
│   └── enc加密存储                   # 加密私钥
└── model.WalletGenerated保存         # 保存钱包信息
```

### 4. 区块链交易处理

```
chain.HandleMessage() (chain/chain_tx.go)
├── Solana链处理
│   ├── solana.TransactionFromDecoder()    # 解析交易
│   ├── parseCallType()                    # 判断交易类型(Jito/General)
│   ├── GetLatestBlockhash()              # 获取最新区块哈希
│   ├── enc.Porter().SigSol()             # 签名交易
│   └── SendAndConfirmTransaction()        # 发送交易
└── EVM链处理
    ├── ethclient.Dial()                  # 连接以太坊节点
    ├── client.PendingNonceAt()           # 获取nonce
    ├── types.NewTransaction()            # 创建交易
    ├── enc.Porter().SigEvmTx()           # 签名交易
    └── client.SendTransaction()          # 发送交易
```

**Jito集成：**
- 支持通过Jito网络发送高优先级交易
- 自动添加tip费用指令
- 支持MEV保护

### 5. 数据存储层

```
system.GetDb() (system/mysql.go)
├── GORM配置                    # ORM配置
├── MySQL连接                   # 数据库连接
└── 自定义Logger               # 日志记录

主要数据表：
├── wallet_generated           # 已生成钱包
├── wallet_group              # 钱包组
├── wallet_log                # 操作日志
├── wallet_keys               # 钱包访问密钥
├── sys_channel               # 系统渠道
├── auth_account              # 用户账户
├── meme_vault               # MEME基金
└── ido_log                  # IDO记录
```

### 6. 安全认证流程

```
interceptor.HttpInterceptor() (api/interceptor/interceptor.go)
├── 提取请求头信息
│   ├── APP_ID                # 应用标识
│   ├── SIG                   # 签名
│   ├── TS                    # 时间戳
│   └── REQUEST_ID            # 请求ID
├── queryKeys()               # 查询渠道配置(缓存60秒)
├── SysChannel.Verify()       # SHA256签名验证
└── 设置上下文变量            # 传递认证信息
```

**签名算法：**
```
data = APP_ID + REQUEST_ID + TS + VER
signData = data + APP_KEY
signature = SHA256(signData)
```

### 7. 外部服务集成

```
swapData/ (交换数据获取)
├── okx.go                    # OKX DEX集成
├── jup.go                    # Jupiter DEX集成
└── bsc0x.go                  # 0x协议集成

tasks/ (后台任务)
├── handleTx.go               # 交易处理任务
└── txTask.go                 # 交易任务调度
```

## 主要功能模块

### 1. 钱包管理功能

**钱包生成：**
- 支持多链钱包生成（Solana, BSC, Ethereum等）
- 分组管理，每个用户可有多个钱包组
- 私钥AES加密存储
- 支持助记词导入/导出

**钱包操作：**
- 交易签名（离线签名）
- 资金转账
- 代币交换
- ATA账户管理（Solana）

### 2. 交易处理功能

**Solana交易：**
- 支持原生SOL转账
- SPL代币转账
- Jito网络集成
- 优先费设置
- 交易模拟

**EVM交易：**
- 原生代币转账
- ERC20代币转账
- Gas费用管理
- Nonce管理

### 3. 用户认证功能

**多种登录方式：**
- TG登录集成
- 传统用户名密码
- 2FA双重认证

**权限管理：**
- 基于APP_ID的渠道隔离
- 钱包访问密钥管理
- 限价单专用密钥

### 4. MEME基金功能

**基金管理：**
- MEME代币投资
- 基金钱包管理
- 投资记录追踪
- 收益分配

### 5. IDO功能

**IDO参与：**
- IDO项目验证
- 投资记录
- 代币分发

## 配置文件结构

```yaml
# config/dev.yml
database:           # 数据库配置
  type: mysql
  host: localhost
  port: 3306
  
redis:             # Redis配置
  host: localhost
  port: 6379
  
chain:             # 区块链配置
  - name: SOLANA
    wsRpc: wss://...
    queryRpc: 
      - https://...
      
http:              # HTTP服务配置
  port: 8080
  
cmd:               # 命令行服务配置
  port: 9090
  host: 0.0.0.0
  
mail:              # 邮件配置
  host: smtp.gmail.com
  port: 587
```

## 日志和监控

**日志系统：**
- 基于logrus的结构化日志
- 分级日志记录
- 钱包操作审计日志
- 交易状态追踪

**操作记录：**
- 所有钱包操作记录到wallet_log表
- 包含交易哈希、签名、错误信息
- 支持操作回溯和审计

## 安全措施

1. **私钥保护：**
   - AES加密存储
   - 密钥分离存储
   - 内存安全处理

2. **网络安全：**
   - HTTPS强制
   - 请求签名验证
   - 防重放攻击

3. **访问控制：**
   - 渠道隔离
   - 时效性密钥
   - 2FA认证

4. **交易安全：**
   - 交易确认机制
   - 多节点验证
   - 状态检查

## 部署和运维

**启动参数：**
```bash
./main -p 9090 -mode slot
```

**环境变量：**
- `DALINK_GO_CONFIG_PATH`: 配置文件路径

**监控端点：**
- `/index`: 健康检查
- `:6060/debug/pprof/`: 性能分析（可选）

## 注意事项

1. **安全警告：**
   - 私钥一旦丢失无法恢复
   - 生产环境必须使用HTTPS
   - 定期备份数据库

2. **性能考虑：**
   - RPC节点负载均衡
   - 数据库连接池管理
   - 缓存策略优化

3. **扩展性：**
   - 支持新增区块链
   - 模块化设计便于维护
   - 水平扩展友好

## 总结

HelloSecurity 项目是一个功能完整的加密货币钱包安全服务，通过模块化设计实现了钱包管理、交易处理、用户认证等核心功能。系统采用分层架构，具有良好的可扩展性和安全性，适合作为钱包服务的后端基础设施使用。 